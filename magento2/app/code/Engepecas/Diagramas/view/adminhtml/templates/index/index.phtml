<?php
/**
 * @var $block \Engepecas\Diagramas\Block\Adminhtml\Index\Index
 */
<<<<<<< HEAD
//echo $block->getBaseUrl() . 'admin/diagramas/action/addAttachment';

=======

$bloco = $block->getLayout()->createBlock('Engepecas\Diagramas\Block\Adminhtml\Index\Index');
$upload_bloco = $block->getLayout()->createBlock('Engepecas\Diagramas\Block\Adminhtml\Index\Booking');
<<<<<<< HEAD
<<<<<<< HEAD
$teste = $bloco->getDiagramas();
echo '<pre>';
echo '<textarea class="form-control" name="desc" id="desc" cols="30" rows="10">'.$teste[0]['value'].'</textarea>';
echo '</pre>';*/
>>>>>>> ivan
=======
>>>>>>> ivan
=======

>>>>>>> ivan
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$storeManager = $objectManager->create('\Magento\Store\Model\StoreManagerInterface');
$baseURL_l = $social_image_url = $storeManager->getStore()->getBaseUrl();
$caminho = $baseURL_l.'pub/media/img/';
?>

<head>
    <style>
    #selecao {
        border: 2px #aaf solid;
        position: absolute;
        display: none;
        background-color: rgba(255, 0, 0, 0.3);
    }


    #salva {
        display: none;
    }

    #imagem {
        position: initial;
        top: 100px;
        left: 105px;
    }

    #Enviar {
        display: none;
    }

    #uploadPreview {
        width: auto;
        height: auto;
    }

    .page-header{
        margin-top: 0 !important;
        padding: 0 3rem !important;
    }
    #description{
        margin-top: 0 !important;
        padding: 0 0 0 !important;
    }
    </style>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<?php
<<<<<<< HEAD
/*$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$storeManager = $objectManager->create('\Magento\Store\Model\StoreManagerInterface');
$baseURL_l = $social_image_url = $storeManager->getStore()->getBaseUrl();*/


?>

<form action="" method="post" enctype="multipart/form-data">
    <div class="custom-file col-md-4">
        <input type="file" class="custom-file-input" name="arquivo" id="arquivo">
        <label class="custom-file-label" for="validatedCustomFile">Carregar diagrama...</label>
    </div>
    <input type="submit" class="btn btn-primary" value="Enviar">
</form>
<?php
<<<<<<< HEAD
=======
>>>>>>> ivan
=======
$url = $this->getUrl('diagramas/index/index', ['_secure'=> true]);
?>
<div id="imagem">
    <img id="uploadPreview" />
    <div id="selecao"></div>
</div>
<div class="row">
    <div style="text-align: center;">
        <div class="col-12">
            <form id="upload" action="<?=$url?>" method="POST" enctype="multipart/form-data">
                <input id="uploadImage" type="file" class="form-control-file" name="myPhoto"
                    onchange="PreviewImage();" />
            </form>
        </div>
    </div>
</div>

</br>
<?php
>>>>>>> ivan
$img = '';
$img_tmp = '';
$img_cam = "http://192.168.0.241:5000/magento2/pub/media/img/";
$motor_diagrama = $bloco->getIdMotorDiagrama();
$url = $this->getUrl('diagramas/index/index', ['_secure'=> true]);

?>

<div class="row">
    <div class="col-12">
        <form action="<?=$url?>">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label>SKU</label>
                    <small>(CODIGO DA PEÇA)</small>
                    <input type="text" class="form-control" name="sku" id="sku">
                    <input type="hidden" class="form-control" name="titulo" id="titulo">
                    <input type="hidden" class="form-control" name="id" id="id">
                    <input type="hidden" class="form-control" name="link" id="link">
                    <input type="hidden" class="form-control" name="price" id="price">
                    <input type="hidden" class="form-control" name="entity_id" id="entity_id">
                    <label>Produto</label>
                    <small>(PRODUTO ONDE VAI MOSTRAR O DIAGRAMA)</small>
                    <select class="form-control" id="id_prod">
                        <?php
                            echo "<option  value='0'>Escolha uma opção</option>";
                        foreach($motor_diagrama as $value){
                            $id = $value['entity_id'];
                            $valor = $value['VALUE'];
                            echo "<option  value='$id'>$valor</option>";
                        }
                        ?>
                    </select>
                </div>
            </div>
            <button type="button" class="action- scalable action-secondary add" id="add">Adicionar</button>
            <button type="button" class="action-default primary" id="slv">Salvar</button>
        </form><br>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <div id="tabela">
                    <p>Vai aparecer aqui...</p>
        </div>
    </div>
    <div class="col-12">
        <form action="<?=$url?>" method="POST" id="upload">
            <div id="info">
            </div>
            <button type="submit" id="salva" class="btn btn-primary text-white">Salvar</button>
        </form>
    </div>
</div>

<!-- Optional JavaScript -->
<script>

let img_cam = document.querySelector('#uploadImage');
let sku = document.getElementById('sku');
let id_prod = document.getElementById('id_prod');
let tr;


function PreviewImage() {
    let imagem = document.getElementById("uploadImage");
    var oFReader = new FileReader();
    oFReader.readAsDataURL(imagem.files[0]);
    oFReader.onload = function(oFREvent) {
        document.getElementById("uploadPreview").src = oFREvent.target.result;
        imagem.style.display = 'none';
    };
};

require(['jquery', 'jquery/ui'], function($) {

    var form = $("#upload")[0];

    $("#uploadImage").on("change", function(event) {
        var data = new FormData(form);
        $.ajax({
            url: form.action,
            data: data,
            contentType: false,
            processData: false,
            type: form.method,
            success: function(data) {
                console.log(data);
            }
        });
        return false;
    });
});



/*** seleciona area da imagem e pega as coordenadas */
let img = document.getElementById('uploadPreview');
let selecao = document.getElementById('selecao');

function arrastador(e) {
    e.preventDefault();
    selecao.style.width = e.pageX - inicio.x + 'px';
    selecao.style.height = e.pageY - inicio.y + 'px';
}

img.addEventListener('mousedown', function(e) {
    inicio = {
        x: e.pageX,
        y: e.pageY
    };
    selecao.style.display = 'block';
    selecao.style.left = inicio.x + 'px';
    selecao.style.top = inicio.y + 'px';
    selecao.style.width = 0;
    selecao.style.height = 0;
    window.addEventListener('mousemove', arrastador);
});

window.addEventListener('mouseup', function(e) {
    inicio = null;
    window.removeEventListener('mousemove', arrastador);
});


let pos;
require(['jquery', 'jquery/ui'], function($) {
    var url_prod = $("#link");
    $('#add').on('click', function(e) {
        pos = selecao.getBoundingClientRect();
        var wh = $('#uploadPreview');
        var w = wh.width();
        var h = wh.height();
        var entity_id_motor_ =  id_prod.value;
        left_ = pos.left - $('#imagem').offset().left + $(window).scrollLeft();
        top_ = pos.top + $(window).scrollTop();//$('#imagem').offset().top; // + $(window).scrollTop();
        right = pos.right;
        bottom = pos.bottom;
        var valor_sku = sku.value;/**Código sku da peça */
        $.ajax({
            type: 'post',
            url: url_prod,
            data: {
                entity_id_motor: `${entity_id_motor_}`,
                sku: `${valor_sku}`,
                left: `${left_}`,
                top: `${top_}`,
                left_b: `${right}`,
                top_b: `${bottom}`
            },
            error: function() {
                alert('Erro ao tentar ação!');
            },
            success: function(retorno) {
                //alert(retorno);
                var json = JSON.parse(retorno);
                var x = 0;
                tr = '';
                while(x < json.length){
                    tr += `
                        <tr>
                            <th><img src="${json[x].imagem}" style="width: 100px"></th>
                            <th>${json[x].sku}</th>
                            <th>${json[x].value}</th>
                            <th>${json[x].request_path}</th>
                            <th>${json[x].price}</th>
                            <th><button type="button" class="btn btn-dark" onclick="DeleteProd(${json[x].diagrama_id});">Remover</button></th>
                        </tr>
                    `;
                    x++;
                }
                gerarTabela(tr);
            }
        });
    });

    $('#id_prod').on('change', function(){
        //id_prod.disabled = true;
        $.ajax({
            type: 'post',
            url: url_prod,
            data: {
                entity_id_motor: `${id_prod.value}`
            },
            error: function() {
                alert('Erro ao tentar ação!');
            },
            success: function(retorno) {
                var json = JSON.parse(retorno);
                var x = 0;
                tr = '';
                while(x < json.length){
                    tr += `
                        <tr>
                            <th><img src="${json[x].imagem}" style="width: 100px"></th>
                            <th>${json[x].sku}</th>
                            <th>${json[x].value}</th>
                            <th>${json[x].request_path}</th>
                            <th>${json[x].price}</th>
                            <th><button type="button" class="btn btn-dark" onclick="DeleteProd('${json[x].diagrama_id}',);">Remover</button></th>
                        </tr>
                    `;
                    x++;
                }
                gerarTabela(tr);
            }
        });
    });

    $('#slv').on('click', function(){
        var id_motor_ =  id_prod.value;
        var file_ = '<?=$caminho?>' + img_cam.files[0].name;
        //alert(id_motor_);
        $.ajax({
            type: 'post',
            url: url_prod,
            data: {
                id_motor: `${id_motor_}`,
                file_url: `${file_}`
            },
            error: function() {
                alert('Erro ao tentar ação!');
            },
            success: function(retorno) {
                console.log(retorno);
            }
        });
    });
});

function DeleteProd(id){
    require(['jquery', 'jquery/ui'], function($) {
        var entity_id_motor_ =  id_prod.value;
        var url_prod = $("#link");
        $.ajax({
            type: 'post',
            url: url_prod,
            data: {
                deletar: 'true',
                entity_id_motor: `${entity_id_motor_}`,
                id: `${id}`
            },
            error: function(){

            },
            success: function(retorno){
                var json = JSON.parse(retorno);
                var x = 0;
                tr = '';
                while(x < json.length){
                    tr += `
                        <tr>
                            <th><img src="${json[x].imagem}" style="width: 100px"></th>
                            <th>${json[x].sku}</th>
                            <th>${json[x].value}</th>
                            <th>${json[x].request_path}</th>
                            <th>${json[x].price}</th>
                            <th><button type="button" class="btn btn-dark" onclick="DeleteProd('${json[x].diagrama_id}',);">Remover</button></th>
                        </tr>
                    `;
                    x++;
                }
                gerarTabela(tr);
            }
        });
    });
}

function gerarTabela(tr){
    let tabela = document.getElementById('tabela');
    var tabela_texto = `
    <table class="table">
        <thead class="thead-dark">
            <tr>
            <th scope="col">Miniatura</th>
            <th scope="col">SKU</th>
            <th scope="col">Nome</th>
            <th scope="col">URL</th>
            <th scope="col">Preço</th>
            <th scope="col"></th>
            </tr>
        </thead>
        <tbody>
            ${tr}
        </tbody>
    </table>
    `;

    tabela.innerHTML = tabela_texto;
}
</script>
